
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Updating GitHub to GraphQL 1.8.0 - Robert Mosolgo</title>
  <meta name="author" content="Robert Mosolgo">

  
  <meta name="description" content="GraphQL 1.8.0 was designed and built largely as a part of my work at GitHub. Besides designing the new Schema definition API, I migrated our codebase &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rmosolgo.github.io/blog/2018/04/09/updating-github-to-graphql-1-dot-8-0">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/RobertMosolgo" rel="alternate" title="Robert Mosolgo" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Gentium+Book+Basic' rel='stylesheet' type='text/css'>

  

</head>

<body   class="no-sidebar"  >
  <div id="wrapper">
    <header role="banner"><hgroup>
  <h1 class="site-title">
  	<a href="/">Robert Mosolgo</a>
  </h1>
  
</hgroup>

</header>
    <nav role="navigation"><ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Blog</a></li>
  <li><a href="/talks">Talks</a></li>
  <li><a href="http://feeds.feedburner.com/RobertMosolgo" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
</ul>

</nav>
    <div id="main">
      <div id="content">
        <div>
<article class="hentry" role="article">
  

  
  <header>
    
      <h1 class="entry-title">Updating GitHub to GraphQL 1.8.0</h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-04-09T09:52:00-04:00" pubdate data-updated="true">Apr 9<span>th</span>, 2018</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>GraphQL 1.8.0 was designed and built largely as a part of my work at GitHub. Besides designing the <a href="http://graphql-ruby.org/schema/class_based_api">new Schema definition API</a>, I migrated our codebase to use it. Here are some field notes from my migration.</p>

<!-- more -->


<p>If you want to know more about the motivations behind this work, check out this <a href="/blog/2018/03/25/why-a-new-schema-definition-api/">previous post</a>.</p>

<p>Below, I&rsquo;ll cover:</p>

<ul>
<li>The Process: in general, how I went about migrating our code</li>
<li>The Upgrader: how to run it and roughly how it&rsquo;s organized</li>
<li>Custom Transforms: extensions I made for the upgrader to work on GitHub-specific code</li>
<li>Fixes By Hand: bits of code that needed more work (some of these could be automated, but aren&rsquo;t yet!)</li>
<li>Porting Relay Types: using the class-based API for connections and edges</li>
<li>Migrating DSL extensions: how to support custom GraphQL extension in the new API</li>
</ul>


<h2>The Process</h2>

<p>GitHub&rsquo;s type definitions are separated into folders by type, for example: <code>objects/</code>, <code>unions/</code>, <code>enums/</code> (and <code>mutations/</code>). I worked through them one folder at a time. The <code>objects/</code> folder was big, so I did it twenty or thirty files at a time.</p>

<p>I had to do <code>interfaces/</code> last because of the nature of the new class-based schema. Interfaces modules&#8217; methods can&rsquo;t be added to legacy-style GraphQL object types. So, by doing interfaces last, I didn&rsquo;t have to worry about this compatibility issue.</p>

<p>Now that I remember it, I did the schema <em>first</em>, and by hand. It was a pretty easy upgrade.</p>

<p>When I started each section, I created a base class by hand. (There is some automated support for this, but I didn&rsquo;t use it.) Then, I ran the upgrader on some files and tried to run the test suite. There were usually two kinds of errors:</p>

<ul>
<li>Parse- or load-time errors which prevented the app from booting</li>
<li>Runtime errors which resulted in unexpected behavior or raised errors</li>
</ul>


<p>More on these errors below.</p>

<p>After upgrading a section of the schema, I opened a PR for review from the team. This was crucial: since I was working at such a large scale, it was easy for me to miss the trees for the forest. My teammates caught a lot of things during the process!</p>

<p>After a review, the PR would be merged into master. Since GraphQL 1.8.0 supports incremental migration, I could work through the code in chunks without a long running branch or feature flags.</p>

<h2>About the Upgrader</h2>

<p>Here&rsquo;s an overview of how the upgrader works. After reading the overview, if you want some specific examples, check out the <a href="https://github.com/rmosolgo/graphql-ruby/blob/master/lib/graphql/upgrader/member.rb">source code</a>.</p>

<h3>Running The Upgrader</h3>

<p>The gem includes an auto-upgrader, spearheaded by the folks at <a href="https://hackerone.com">HackerOne</a> and refined during my use of it. It&rsquo;s encapsulated in a class, <code>GraphQL::Upgrader::Member</code>.</p>

<p>To use the upgrader, I added a Ruby script to the code base called <code>graphql-update.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Usage:</span>
</span><span class='line'><span class="c1">#   ruby graphql-update.rb path/to/type_definition.rb</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Example:</span>
</span><span class='line'><span class="c1">#   # Upgrade `BlameRange`</span>
</span><span class='line'><span class="c1">#   ruby graphql-update.rb lib/platform/objects/blame_range.rb</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#   # Upgrade based on a pattern (use quotes)</span>
</span><span class='line'><span class="c1">#   ruby graphql-update.rb &quot;lib/platform/objects/blob_\*.rb&quot;</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#   # Upgrade one more file in this pattern (use quotes)</span>
</span><span class='line'><span class="c1">#   ruby graphql-update.rb 1 &quot;lib/platform/objects/**.rb&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Load the upgrader from local code, for easier trial-and-error development</span>
</span><span class='line'><span class="c1"># require &quot;~/code/graphql-ruby/lib/graphql/upgrader/member&quot;</span>
</span><span class='line'><span class="c1"># Load the upgrader from the Gem:</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;graphql/upgrader/member&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Accept two arguments: next_files (optional), file_pattern (required)</span>
</span><span class='line'><span class="n">file_pattern</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'><span class="k">if</span> <span class="n">file_pattern</span> <span class="o">=~</span> <span class="sr">/\d+/</span>
</span><span class='line'>  <span class="n">next_files</span> <span class="o">=</span> <span class="n">file_pattern</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>  <span class="n">next_files_pattern</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="s2">&quot;Upgrading </span><span class="si">#{</span><span class="n">next_files</span><span class="si">}</span><span class="s2"> more files in </span><span class="si">#{</span><span class="n">next_files_pattern</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">filenames</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">next_files_pattern</span><span class="p">)</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="n">filenames</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_pattern</span><span class="p">)</span>
</span><span class='line'>  <span class="n">next_files</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Upgrading </span><span class="si">#{</span><span class="n">filenames</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># ...</span>
</span><span class='line'><span class="c1"># Lots of custom rules here, see below</span>
</span><span class='line'><span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'><span class="no">CUSTOM_TRANSFORMS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">type_transforms</span><span class="p">:</span> <span class="n">type_transforms</span><span class="p">,</span>
</span><span class='line'>  <span class="n">field_transforms</span><span class="p">:</span> <span class="n">field_transforms</span><span class="p">,</span>
</span><span class='line'>  <span class="n">clean_up_transforms</span><span class="p">:</span> <span class="n">clean_up_transforms</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">skip</span><span class="p">:</span> <span class="no">CustomSkip</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">upgraded</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="n">filenames</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Begin (</span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span class='line'>  <span class="c1"># Read the file into a string</span>
</span><span class='line'>  <span class="n">original_text</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># Create an Upgrader with the set of custom transforms</span>
</span><span class='line'>  <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Upgrader</span><span class="o">::</span><span class="no">Member</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">original_text</span><span class="p">,</span> <span class="o">**</span><span class="no">CUSTOM_TRANSFORMS</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># Generate updated text</span>
</span><span class='line'>  <span class="n">transformed_text</span> <span class="o">=</span> <span class="n">upgrader</span><span class="o">.</span><span class="n">upgrade</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">transformed_text</span> <span class="o">==</span> <span class="n">original_text</span>
</span><span class='line'>    <span class="c1"># No upgrade was performed</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># If the upgrade was successful, update the source file</span>
</span><span class='line'>    <span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">transformed_text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">upgraded</span> <span class="o">&lt;&lt;</span> <span class="n">filename</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Done (</span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">next_files</span> <span class="o">&amp;&amp;</span> <span class="n">upgraded</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">next_files</span>
</span><span class='line'>    <span class="c1"># We&#39;ve upgraded as many as we said we would</span>
</span><span class='line'>    <span class="k">break</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Upgraded </span><span class="si">#{</span><span class="n">upgraded</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> files: </span><span class="se">\n</span><span class="si">#{</span><span class="n">upgraded</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This script has two basic parts:</p>

<ul>
<li>Using <code>GraphQL::Upgrader::Member</code> with a set of custom transformations</li>
<li>Supporting code: accepting input, counting files, logging, etc</li>
</ul>


<p>In your own script, you can write whatever supporting code you want. The key part from GraphQL-Ruby is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Create an Upgrader with the set of custom transforms</span>
</span><span class='line'><span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Upgrader</span><span class="o">::</span><span class="no">Member</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">original_text</span><span class="p">,</span> <span class="o">**</span><span class="no">CUSTOM_TRANSFORMS</span><span class="p">)</span>
</span><span class='line'><span class="c1"># Generate updated text</span>
</span><span class='line'><span class="n">transformed_text</span> <span class="o">=</span> <span class="n">upgrader</span><span class="o">.</span><span class="n">upgrade</span>
</span></code></pre></td></tr></table></div></figure>


<h3>The Pipeline</h3>

<p>The upgrader is structured as a pipeline: each step accepts a big string of input and returns a big string of output. Sometimes, a step does nothing and so its returned string is the same as the input string. In general, the transforms consist of two steps:</p>

<ul>
<li>Check whether the transform applies to the given input</li>
<li>If it does, copy the string and apply a find-and-replace to it (sometimes using RegExp, other times using the excellent <code>parser</code> gem.)</li>
</ul>


<p>You have a few options for customizing the transformation pipeline:</p>

<ul>
<li>Write new transforms and add them to the pipeline</li>
<li>Remove transforms from the pipeline</li>
<li>Re-use the built-in transforms, but give them different parameters, then replace the built-in one with your custom instance</li>
</ul>


<p>(The &ldquo;pipeline&rdquo; is just an array of instances or subclasses of <code>GraphQL::Upgrader::Transform</code>.)</p>

<p>We&rsquo;ll see cases of each below.</p>

<h3>Kinds of Transforms</h3>

<p>The upgrader accepts several types of transform pipelines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CUSTOM_TRANSFORMS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">type_transforms</span><span class="p">:</span> <span class="n">type_transforms</span><span class="p">,</span>
</span><span class='line'>  <span class="n">field_transforms</span><span class="p">:</span> <span class="n">field_transforms</span><span class="p">,</span>
</span><span class='line'>  <span class="n">clean_up_transforms</span><span class="p">:</span> <span class="n">clean_up_transforms</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">skip</span><span class="p">:</span> <span class="no">CustomSkip</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>type_transforms</code> are run first, on the <em>entire</em> file.</li>
<li><code>field_transforms</code> are run second, but they receive <em>parts</em> of the type definition. They receive calls to <code>field</code>, <code>connection</code>, <code>return_field</code>, <code>input_field</code>, and <code>argument</code>. Fine-grained changes to field definition or argument definition go here.</li>
<li><code>clean_up_transforms</code> are run last, on the <em>entire</em> file. For example, there&rsquo;s a built-in <code>RemoveExcessWhitespaceTransform</code> which cleans up trailing spaces after other transforms have run.</li>
<li><code>skip:</code> has a special function: its <code>#skip?(input)</code> method is called and if it returns true, the text is not transformed at all. This allows the transformer to be idempotent: by default, if you run it on the same file over and over, it will update the file only <em>once</em>.</li>
</ul>


<h2>Custom Transforms</h2>

<p>Here are some custom transforms applied to our codebase.</p>

<h3>Handle a custom type-definition DSL</h3>

<p>We had a wrapper around <code>ObjectType.define</code> which attached metadata, linking the object type to a specific Rails model. The helper was called <code>define_active_record_type</code>. I wanted to take this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Platform</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Objects</span>
</span><span class='line'>    <span class="no">Issue</span> <span class="o">=</span> <span class="n">define_active_record_type</span><span class="p">(</span><span class="o">-&gt;</span> <span class="p">{</span> <span class="o">::</span><span class="no">Issue</span> <span class="p">})</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1"># ...</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And make it this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Platform</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Objects</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Issue</span> <span class="o">&lt;</span> <span class="ss">Platform</span><span class="p">:</span><span class="ss">:Objects</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>      <span class="n">model_name</span> <span class="s2">&quot;Issue&quot;</span>
</span><span class='line'>      <span class="c1"># ...</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Fortunately, this can be done with a pretty straightforward regular expression substitution. Here&rsquo;s the transform:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Create a custom transform for our `define_active_record_type` factory:</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ActiveRecordTypeToClassTransform</span> <span class="o">&lt;</span> <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Upgrader</span><span class="o">::</span><span class="no">Transform</span>
</span><span class='line'>  <span class="c1"># Capture: leading whitespace, type name, model name</span>
</span><span class='line'>  <span class="no">FIND_PATTERN</span> <span class="o">=</span> <span class="sr">/^( +)([a-zA-Z_0-9:]*) = define_active_record_type\(-&gt; ?\{ ?:{0,2}([a-zA-Z_0-9:]*) ?\} ?\) do/</span>
</span><span class='line'>  <span class="c1"># Restructure as a class, using the leading whitespace and adding the `model_name` DSL</span>
</span><span class='line'>  <span class="no">REPLACE_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1class </span><span class="se">\\</span><span class="s2">2 &lt; Platform::Objects::Base</span><span class="se">\n\\</span><span class="s2">1  model_name </span><span class="se">\&quot;\\</span><span class="s2">3</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># It&#39;s safe to apply this transform to _all_ input,</span>
</span><span class='line'>    <span class="c1"># since it&#39;s a no-op if `FIND_PATTERN` is missing.</span>
</span><span class='line'>    <span class="n">input_text</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="no">FIND_PATTERN</span><span class="p">,</span> <span class="no">REPLACE_PATTERN</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, in <code>graphql-update.rb</code>, this transform was put <em>first</em> in the list:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># graphql-update.rb</span>
</span><span class='line'><span class="n">type_transforms</span> <span class="o">=</span> <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Upgrader</span><span class="o">::</span><span class="ss">Member</span><span class="p">:</span><span class="ss">:DEFAULT_TYPE_TRANSFORMS</span><span class="o">.</span><span class="n">dup</span>
</span><span class='line'><span class="n">type_transforms</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="no">ActiveRecordTypeToClassTransform</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, for this to work, I added the <code>def self.model_name(name)</code> helper to the base class.</p>

<h3>Renaming a Custom Field Method</h3>

<p>We have a helper for adding URL fields called <code>define_url_field</code>. I decided to rename this to <code>url_fields</code>, since these days it creates <em>two</em> fields.</p>

<p>The arguments are the same, so it was a simple substitution:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UrlFieldTransform</span> <span class="o">&lt;</span> <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Upgrader</span><span class="o">::</span><span class="no">Transform</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># Capture the leading whitespace and the rest of the line,</span>
</span><span class='line'>    <span class="c1"># then insert the new name where the old name used to be</span>
</span><span class='line'>    <span class="n">input_text</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/^( +)define_url_field( |\()/</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1url_fields</span><span class="se">\\</span><span class="s2">2&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This transform didn&rsquo;t interact with any other transforms, so I added it to <code>clean_up_transforms</code>, so it would run last:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Make a copy of the built-in arry</span>
</span><span class='line'><span class="n">clean_up_transforms</span> <span class="o">=</span> <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Upgrader</span><span class="o">::</span><span class="ss">Member</span><span class="p">:</span><span class="ss">:DEFAULT_CLEAN_UP_TRANSFORMS</span><span class="o">.</span><span class="n">dup</span>
</span><span class='line'><span class="c1"># Add my custom transform to the end of the array</span>
</span><span class='line'><span class="n">clean_up_transforms</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="no">UrlFieldTransform</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Moving DSL methods to keywords</h3>

<p>We have a few DSL methods that, at the time, were easier to implement as keyword arguments. (Since then, the API has changed a bit. You can implement DSL methods on your fields by extending <code>GraphQL::Schema::Field</code> and setting that class as <code>field_class</code> on your base Object, Interface and Mutation classes.)</p>

<p>I wanted to transform:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">field</span> <span class="ss">:secretStuff</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">String</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">visibility</span> <span class="ss">:secret</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">field</span> <span class="ss">:secretStuff</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="ss">visibility</span><span class="p">:</span> <span class="ss">:secret</span>
</span></code></pre></td></tr></table></div></figure>


<p>(Later, a built-in upgrader would change <code>secretStuff</code> to <code>secret_stuff</code> and <code>types.String</code> to <code>String, null: true</code>.)</p>

<p>To accomplish this, I reused a built-in transform, <code>ConfigurationToKwargTransform</code>, adding it to <code>field_transforms</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Make a copy of the built-in list of defaults</span>
</span><span class='line'><span class="n">field_transforms</span> <span class="o">=</span> <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Upgrader</span><span class="o">::</span><span class="ss">Member</span><span class="p">:</span><span class="ss">:DEFAULT_FIELD_TRANSFORMS</span><span class="o">.</span><span class="n">dup</span>
</span><span class='line'><span class="c1"># Put my custom transform at the beginning of the list</span>
</span><span class='line'><span class="n">field_transforms</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Upgrader</span><span class="o">::</span><span class="no">ConfigurationToKwargTransform</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">kwarg</span><span class="p">:</span> <span class="s2">&quot;visibility&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In fact, there were several configuration methods moved this way.</p>

<h3>Custom Skip</h3>

<p>As I was working through the code, some files were tougher than others. So, I decided to skip them. I decided that a magic comment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># @skip-auto-upgrade</span>
</span></code></pre></td></tr></table></div></figure>


<p>would cause a file to be skipped. To implement this, I made a custom skip class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CustomSkip</span> <span class="o">&lt;</span> <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Upgrader</span><span class="o">::</span><span class="no">SkipOnNullKeyword</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">skip?</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span> <span class="o">||</span> <span class="n">input_text</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;@skip-auto-upgrade&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And passed it as <code>skip:</code> to the upgrader. Then, later, I removed the comment and tried again. (Fortunately, my procrastination paid off because the upgrader was improved in the meantime!)</p>

<h2>Fixes by Hand</h2>

<p>As I worked, I improved the upgrader to cover as many cases as I could, but there are still a few cases that I had to upgrade by hand. I&rsquo;ll list them here. If you&rsquo;re really dragged down by them, consider opening an issue on GraphQL-Ruby to talk about fixing them. I&rsquo;m sure they <em>can</em> be fixed, I just didn&rsquo;t get to it!</p>

<p>If you want to fix one of these issues, try to replicate the issue by adding to an example <code>spec/fixtures/upgrader</code> and then getting a failing test. Then, you could update the upgrader code to fix that broken test.</p>

<h3>Accessing Arguments By Method</h3>

<p>Arguments could be accessed by method to avoid typos. However, now, since arguments are a Ruby keyword hash, they don&rsquo;t have methods corresponding to their keys.</p>

<p>Unfortunately, the upgrader doesn&rsquo;t do anything about this, it just leaves them there and you get a <code>NoMethodError</code> on <code>Hash</code>.</p>

<p>This could almost certainly be fixed by improving this find-and-replace in <code>ResolveProcToMethodTransform</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Update Argument access to be underscore and symbols</span>
</span><span class='line'><span class="c1"># Update `args[...]` and `args.key?`</span>
</span><span class='line'><span class="n">method_body</span> <span class="o">=</span> <span class="n">method_body</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/</span><span class="si">#{</span><span class="n">args_arg_name</span><span class="si">}</span><span class="sr">(?&lt;method_begin&gt;\.key\?\(?|\[)[&quot;&#39;:](?&lt;arg_name&gt;[a-zA-Z0-9_]+)[&quot;&#39;]?(?&lt;method_end&gt;\]|\))?/</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'> <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It only updates a few methods on <code>args</code>, but I bet a similar find-and-replace could replace <em>other</em> method calls, too.</p>

<h3>Argument Usages Outside of Type Definitions</h3>

<p>Sometimes, we take GraphQL arguments and pass them to helper methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resolve</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">Some</span><span class="p">:</span><span class="ss">:Helper</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>However when this was transformed to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">do_stuff</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
</span><span class='line'>  <span class="ss">Some</span><span class="p">:</span><span class="ss">:Helper</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="vi">@object</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would break, because the new <code>arguments</code> value is a Ruby hash with underscored, symbol keys. So, if <code>Some::Helper</code> was using camelized strings to get values, it would stop working.</p>

<p>The upgrader can&rsquo;t really do anything there, since it&rsquo;s not analyzing the codebase. In my case, these were readily apparent because of failing tests, so I went and fixed them.</p>

<h3>context.add_error</h3>

<p>We have some fields that add to the <code>"errors"</code> key <em>and</em> return values, they used <code>ctx.add_error</code> to do so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resolve</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="n">obj</span><span class="o">.</span><span class="n">count_things</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">BackendIsBrokenError</span>
</span><span class='line'>    <span class="n">ctx</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:ExecutionError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Not working!&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When upgraded, it doesn&rsquo;t work quite right:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">count_things</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="vi">@object</span><span class="o">.</span><span class="n">count_things</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">BackendIsBrokenError</span>
</span><span class='line'>    <span class="vi">@context</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:ExecutionError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Not working!&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>(If you don&rsquo;t have to return a value, use <code>raise</code> instead, then you can stop reading this part!)</p>

<p>The problem is that <code>@context</code> is not a <em>field-specific</em> context anymore. Instead, it&rsquo;s the query-level context. (This is downside of the new API: we don&rsquo;t have a great way to pass in the field context anymore.)</p>

<p>To address this kind of issues, <code>field</code> accepts a keyword called <code>extras:</code>, which contains a array of symbols. In the case above, we could use <code>:execution_errors</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">field</span> <span class="ss">:count_things</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">extras</span><span class="p">:</span> <span class="o">[</span><span class="ss">:execution_errors</span><span class="o">]</span>
</span><span class='line'><span class="k">def</span> <span class="nf">count_things</span><span class="p">(</span><span class="n">execution_errors</span><span class="p">:)</span>
</span><span class='line'>  <span class="vi">@object</span><span class="o">.</span><span class="n">count_things</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">BackendIsBrokenError</span>
</span><span class='line'>  <span class="n">execution_errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Not working!&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, <code>execution_errors</code> was injected into the field as a keyword. It <em>is</em> field-level, so adding errors there works as before.</p>

<p>Other extras are <code>:irep_node</code>, <code>:parent</code>, <code>:ast_node</code>, and <code>:arguments</code>. It&rsquo;s a bit of a hack, but we need <em>something</em> for this!</p>

<h3>Accessing Connection Arguments</h3>

<p>By default, connection arguments (like <code>first</code>, <code>after</code>, <code>last</code>, <code>before</code>) are <em>not</em> passed to the Ruby methods for implementing fields. This is because they&rsquo;re generally used by the automagical (😖) connection wrappers, not the resolve functions.</p>

<p>But, sometimes you just <em>need</em> those old arguments!</p>

<p>If you use <code>extras: [:arguments]</code>, the legacy-style arguments will be injected as a keyword:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># `arguments` is the legacy-style Query::Arguments instance</span>
</span><span class='line'><span class="c1"># `field_arguments` is a Ruby hash with symbol, underscored keys.</span>
</span><span class='line'><span class="k">def</span> <span class="nf">things</span><span class="p">(</span><span class="ss">arguments</span><span class="p">:,</span> <span class="o">**</span><span class="n">field_arguments</span><span class="p">)</span>
</span><span class='line'>  <span class="n">arguments</span><span class="o">[</span><span class="ss">:first</span><span class="o">]</span> <span class="c1"># =&gt; 5</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Fancy String Descriptions</h3>

<p>The upgrader does fine when the description is a <code>"..."</code> or <code>'...'</code> string. But in other cases, it was a bit wacky.</p>

<p>Strings built up with <code>+</code> or <code>\</code> always broke. I had to go back by hand and join them into one string.</p>

<p>Heredoc strings often <em>worked</em>, but only by chance. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">field</span> <span class="ss">:stuff</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Int</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">description</span> <span class="o">&lt;&lt;~</span><span class="no">MD</span>
</span><span class='line'>    <span class="no">Here</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">the</span> <span class="n">stuff</span>
</span><span class='line'>  <span class="no">MD</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Would be transformed to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">field</span> <span class="ss">:stuff</span><span class="p">,</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="o">&lt;&lt;~</span><span class="no">MD</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>    <span class="no">Here</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">the</span> <span class="n">stuff</span>
</span><span class='line'>  <span class="no">MD</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is valid Ruby, but a bit tricky. This could definitely be improved: since I started my project, GraphQL 1.8 was extended to support <code>description</code> as a <em>method</em> as well as a keyword. So, the upgrader could be improved to leave descriptions in place if they&rsquo;re fancy strings.</p>

<h3>Removed Comments From the Start of Resolve Proc</h3>

<p>I hacked around with the <code>parser</code> gem to transform <code>resolve</code> procs into instance methods, but there&rsquo;s a bug. A proc like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resolve</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1"># Do stuff</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">do_stuff</span> <span class="p">{</span> <span class="n">stuff</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Will be transformed to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">stuff</span>
</span><span class='line'>  <span class="vi">@object</span><span class="o">.</span><span class="n">do_stuff</span> <span class="p">{</span> <span class="n">stuff</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Did you see how the comment was removed? I think I&rsquo;ve somehow wrongly detected the start of the proc body, so that the comment was left out.</p>

<p>In my case, I re-added those comments by hand. But it could probably be fixed in <code>GraphQL::Upgrader::ResolveProcToMethodTransform</code>.</p>

<h3>Hash Reformating?</h3>

<p>I&rsquo;m not sure why, but sometimes a hash of arguments like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">do_stuff</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">d</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>would be reorganized to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">do_stuff</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">d</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I have no idea why, and I didn&rsquo;t look into it, I just fixed it by hand.</p>

<h3>Issues with Connection DSL</h3>

<p>We have a DSL for making connections, like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Connections</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">Objects</span><span class="p">:</span><span class="ss">:Issue</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sometimes, when this connection was inside a proc, it would be wrongly transformed to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">field</span> <span class="ss">:issues</span><span class="p">,</span> <span class="no">Connections</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">Objects</span><span class="p">:</span><span class="ss">:Issue</span><span class="p">)</span> <span class="p">},</span> <span class="p">,</span><span class="ss">null</span><span class="p">:</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was invalid Ruby, so the app wouldn&rsquo;t boot, and I would fix it by hand.</p>

<h2>Porting Relay Types</h2>

<p>Generating connection and edge types with the <code>.connection_type</code>/<code>.define_connection</code> and <code>.edge_type</code>/<code>.define_edge</code> methods will work fine with the new API, but if you want to migrate them to classes, you can do it.</p>

<p>It&rsquo;s on my radar because I want to remove our DSL extensions, and that requires updating our custom connection edge types.</p>

<p>Long story, short, it Just Work™ed with the class-based API. The approach was:</p>

<ul>
<li>Add a base class inheriting from our <code>BaseObject</code></li>
<li>Use the new base class&rsquo;s <code>def self.inherited</code> hook to add connection- and edge-related behaviors</li>
<li>Run the upgrader on edge and connection types, then go back and do some manual find-and-replaces to make them work right</li>
</ul>


<p>So, I will share my base classes in case that helps. Sometime it will be nice to upstream this to GraphQL-Ruby, but I&rsquo;m not sure how to do it now.</p>

<p>Base connection class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Platform</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Connections</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Base</span> <span class="o">&lt;</span> <span class="ss">Platform</span><span class="p">:</span><span class="ss">:Objects</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>      <span class="c1"># For some reason, these are needed, they call through to the underlying connection wrapper.</span>
</span><span class='line'>      <span class="kp">extend</span> <span class="no">Forwardable</span>
</span><span class='line'>      <span class="n">def_delegators</span> <span class="ss">:@object</span><span class="p">,</span> <span class="ss">:cursor_from_node</span><span class="p">,</span> <span class="ss">:parent</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># When this class is extended, add the default connection behaviors.</span>
</span><span class='line'>      <span class="c1"># This adds a new `graphql_name` and description, and searches</span>
</span><span class='line'>      <span class="c1"># for a corresponding edge type.</span>
</span><span class='line'>      <span class="c1"># See `.edge_type` for how the fields are added.</span>
</span><span class='line'>      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">inherited</span><span class="p">(</span><span class="n">child_class</span><span class="p">)</span>
</span><span class='line'>        <span class="c1"># We have a convention that connection classes _don&#39;t_ end in `Connection`, which</span>
</span><span class='line'>        <span class="c1"># is a bit confusing and results in naming conflicts.</span>
</span><span class='line'>        <span class="c1"># To avoid a GraphQL conflict, override `graphql_name` to end in `Connection`.</span>
</span><span class='line'>        <span class="n">type_name</span> <span class="o">=</span> <span class="n">child_class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>        <span class="n">child_class</span><span class="o">.</span><span class="n">graphql_name</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">type_name</span><span class="si">}</span><span class="s2">Connection&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># Use `require_dependency` so that the types will be loaded, if they exist.</span>
</span><span class='line'>        <span class="c1"># Otherwise, `const_get` may reach a top-level constant (eg, `::Issue` model instead of `Platform::Objects::Issue`).</span>
</span><span class='line'>        <span class="c1"># That behavior is removed in Ruby 2.5, then we can remove these require_dependency calls too.</span>
</span><span class='line'>        <span class="k">begin</span>
</span><span class='line'>          <span class="c1"># Look for a custom edge whose name matches this connection&#39;s name</span>
</span><span class='line'>          <span class="n">require_dependency</span> <span class="s2">&quot;lib/platform/edges/</span><span class="si">#{</span><span class="n">type_name</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="n">wrapped_edge_class</span> <span class="o">=</span> <span class="ss">Platform</span><span class="p">:</span><span class="ss">:Edges</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
</span><span class='line'>          <span class="n">wrapped_node_class</span> <span class="o">=</span> <span class="n">wrapped_edge_class</span><span class="o">.</span><span class="n">fields</span><span class="o">[</span><span class="s2">&quot;node&quot;</span><span class="o">].</span><span class="n">type</span>
</span><span class='line'>        <span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">err</span>
</span><span class='line'>          <span class="c1"># If the custom edge file doesn&#39;t exist, look for an object</span>
</span><span class='line'>          <span class="k">begin</span>
</span><span class='line'>            <span class="n">require_dependency</span> <span class="s2">&quot;lib/platform/objects/</span><span class="si">#{</span><span class="n">type_name</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>            <span class="n">wrapped_node_class</span> <span class="o">=</span> <span class="ss">Platform</span><span class="p">:</span><span class="ss">:Objects</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
</span><span class='line'>            <span class="n">wrapped_edge_class</span> <span class="o">=</span> <span class="n">wrapped_node_class</span><span class="o">.</span><span class="n">edge_type</span>
</span><span class='line'>          <span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">err</span>
</span><span class='line'>            <span class="c1"># Assume that `edge_type` will be called later</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># If a default could be found using constant lookups, generate the fields for it.</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">wrapped_edge_class</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">wrapped_edge_class</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:ObjectType</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">wrapped_edge_class</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Class</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">wrapped_edge_class</span> <span class="o">&lt;</span> <span class="ss">Platform</span><span class="p">:</span><span class="ss">:Edges</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span>
</span><span class='line'>            <span class="n">child_class</span><span class="o">.</span><span class="n">edge_type</span><span class="p">(</span><span class="n">wrapped_edge_class</span><span class="p">,</span> <span class="n">node_type</span><span class="p">:</span> <span class="n">wrapped_node_class</span><span class="p">)</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>            <span class="k">raise</span> <span class="no">TypeError</span><span class="p">,</span> <span class="s2">&quot;Missed edge type lookup, didn&#39;t find a type definition: </span><span class="si">#{</span><span class="n">type_name</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> =&gt; </span><span class="si">#{</span><span class="n">wrapped_edge_class</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Configure this connection to return `edges` and `nodes` based on `edge_type_class`.</span>
</span><span class='line'>      <span class="c1">#</span>
</span><span class='line'>      <span class="c1"># This method will use the inputs to create:</span>
</span><span class='line'>      <span class="c1"># - `edges` field</span>
</span><span class='line'>      <span class="c1"># - `nodes` field</span>
</span><span class='line'>      <span class="c1"># - description</span>
</span><span class='line'>      <span class="c1">#</span>
</span><span class='line'>      <span class="c1"># It&#39;s called when you subclass this base connection, trying to use the</span>
</span><span class='line'>      <span class="c1"># class name to set defaults. You can call it again in the class definition</span>
</span><span class='line'>      <span class="c1"># to override the default (or provide a value, if the default lookup failed).</span>
</span><span class='line'>      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">edge_type</span><span class="p">(</span><span class="n">edge_type_class</span><span class="p">,</span> <span class="n">edge_class</span><span class="p">:</span> <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Relay</span><span class="o">::</span><span class="no">Edge</span><span class="p">,</span> <span class="n">node_type</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="c1"># Add the edges field, can be overridden later</span>
</span><span class='line'>        <span class="n">field</span> <span class="ss">:edges</span><span class="p">,</span> <span class="o">[</span><span class="n">edge_type_class</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">true</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">null</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;A list of edges.&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nb">method</span><span class="p">:</span> <span class="ss">:edge_nodes</span><span class="p">,</span>
</span><span class='line'>          <span class="n">edge_class</span><span class="p">:</span> <span class="n">edge_class</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># Try to figure out what the node type is, if it wasn&#39;t provided:</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">node_type</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">edge_type_class</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Class</span><span class="p">)</span>
</span><span class='line'>            <span class="n">node_type</span> <span class="o">=</span> <span class="n">edge_type_class</span><span class="o">.</span><span class="n">fields</span><span class="o">[</span><span class="s2">&quot;node&quot;</span><span class="o">].</span><span class="n">type</span>
</span><span class='line'>          <span class="k">elsif</span> <span class="n">edge_type_class</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:ObjectType</span><span class="p">)</span>
</span><span class='line'>            <span class="c1"># This was created with `.edge_type`</span>
</span><span class='line'>            <span class="n">node_type</span> <span class="o">=</span> <span class="ss">Platform</span><span class="p">:</span><span class="ss">:Objects</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">edge_type_class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;Edge&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>            <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t get node type from edge type: </span><span class="si">#{</span><span class="n">edge_type_class</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># If it&#39;s a non-null type, remove the wrapper</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">node_type</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:of_type</span><span class="p">)</span>
</span><span class='line'>          <span class="n">node_type</span> <span class="o">=</span> <span class="n">node_type</span><span class="o">.</span><span class="n">of_type</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># Make the `nodes` shortcut field, which can be overridden later</span>
</span><span class='line'>        <span class="n">field</span> <span class="ss">:nodes</span><span class="p">,</span> <span class="o">[</span><span class="n">node_type</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">true</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">null</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;A list of nodes.&quot;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># Make a nice description</span>
</span><span class='line'>        <span class="n">description</span><span class="p">(</span><span class="s2">&quot;The connection type for </span><span class="si">#{</span><span class="n">node_type</span><span class="o">.</span><span class="n">graphql_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">field</span> <span class="ss">:page_info</span><span class="p">,</span> <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Relay</span><span class="o">::</span><span class="no">PageInfo</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;Information to aid in pagination.&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># By default this calls through to the ConnectionWrapper&#39;s edge nodes method,</span>
</span><span class='line'>      <span class="c1"># but sometimes you need to override it to support the `nodes` field</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">nodes</span>
</span><span class='line'>        <span class="vi">@object</span><span class="o">.</span><span class="n">edge_nodes</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Base edge class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Platform</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Edges</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Base</span> <span class="o">&lt;</span> <span class="ss">Platform</span><span class="p">:</span><span class="ss">:Objects</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>      <span class="c1"># A description which is inherited and may be overridden</span>
</span><span class='line'>      <span class="n">description</span> <span class="s2">&quot;An edge in a connection.&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">inherited</span><span class="p">(</span><span class="n">child_class</span><span class="p">)</span>
</span><span class='line'>        <span class="c1"># We have a convention that edge classes _don&#39;t_ end in `Edge`,</span>
</span><span class='line'>        <span class="c1"># which is a little bit confusing, and would result in a naming conflict by default.</span>
</span><span class='line'>        <span class="c1"># Avoid the naming conflict by overriding `graphql_name` to include `Edge`</span>
</span><span class='line'>        <span class="n">wrapped_type_name</span> <span class="o">=</span> <span class="n">child_class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>        <span class="n">child_class</span><span class="o">.</span><span class="n">graphql_name</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">wrapped_type_name</span><span class="si">}</span><span class="s2">Edge&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="c1"># Add a default `node` field, assuming the object type name matches.</span>
</span><span class='line'>        <span class="c1"># If it doesn&#39;t match, you can override this in subclasses</span>
</span><span class='line'>        <span class="n">child_class</span><span class="o">.</span><span class="n">field</span> <span class="ss">:node</span><span class="p">,</span> <span class="s2">&quot;Platform::Objects::</span><span class="si">#{</span><span class="n">wrapped_type_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;The item at the end of the edge.&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># A cursor field which is inherited</span>
</span><span class='line'>      <span class="n">field</span> <span class="ss">:cursor</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;A cursor for use in pagination.&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Migrating DSL Extensions</h2>

<p>We have several extensions to the GraphQL-Ruby <code>.define</code> DSL, for example, <code>visibility</code> controls who can see certain types and fields and <code>scopes</code> maps OAuth scopes to GraphQL types.</p>

<p>The difficulty in porting extensions comes from the implementation details of the new API. For now, definition classes are factories for legacy-style type instances. Each class has a <code>.to_graphql</code> method which is called <em>once</em> to return a legacy-style definition. To maintain compatibility, you have to either:</p>

<ul>
<li>Modify the derived legacy-style definition to reflect configurations on the class-based definition; OR</li>
<li>Update your runtime code to <em>stop</em> checking for configurations on the legacy-style definition and <em>start</em> checking for configurations on the class-based definition.</li>
</ul>


<p>Eventually, legacy-style definitions will be phased out of GraphQL-Ruby, but for now, they both exist in this way in order to maintain backwards compatibility and gradual adoptability.</p>

<p>In the mean time, you can go between class-based and legacy-style definitions using <code>.graphql_defintion</code> and <code>.metadata[:type_class]</code>, for example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Project</span> <span class="o">&lt;</span> <span class="no">BaseObject</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">legacy_type</span> <span class="o">=</span> <span class="no">Project</span><span class="o">.</span><span class="n">graphql_definition</span>
</span><span class='line'><span class="c1"># #&lt;GraphQL::ObjectType&gt; instance</span>
</span><span class='line'><span class="n">legacy_type</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:type_class</span><span class="o">]</span>
</span><span class='line'><span class="c1"># `Project` class</span>
</span></code></pre></td></tr></table></div></figure>


<h3>The Easy Way: <code>.redefine</code></h3>

<p>The easiest way to retain compatibility is to:</p>

<ul>
<li>Add a class method to your base classes which accept some configuration and put it in instance variables</li>
<li>Override <code>.to_graphql</code> to call super, and then pass the configuration to <code>defn.redefine(...)</code>, then return the redefined type.</li>
</ul>


<p>After my work on our code, I extracted this into a <a href="http://graphql-ruby.org/type_definitions/extensions.html#customization-compatibility">backport of <code>accepts_definition</code></a></p>

<p>You can take that approach for a try, for example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BaseObject</span> <span class="o">&lt;</span> <span class="ss">GraphQL</span><span class="p">:</span><span class="ss">:Schema</span><span class="o">::</span><span class="no">Object</span>
</span><span class='line'>  <span class="c1"># Add a configuration method</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">visibility</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@visibility</span> <span class="o">=</span> <span class="n">level</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Re-apply the configuration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">to_graphql</span>
</span><span class='line'>    <span class="n">type_defn</span> <span class="o">=</span> <span class="k">super</span>
</span><span class='line'>    <span class="c1"># Call through to the old extension:</span>
</span><span class='line'>    <span class="n">type_defn</span> <span class="o">=</span> <span class="n">type_defn</span><span class="o">.</span><span class="n">redefine</span><span class="p">(</span><span class="ss">visibilty</span><span class="p">:</span> <span class="vi">@visibility</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># Return the redefined type:</span>
</span><span class='line'>    <span class="n">type_defn</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Then, use it in type definitions:</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">BaseObject</span>
</span><span class='line'>  <span class="n">visibility</span><span class="p">(</span><span class="ss">:secret</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>The Hard Way: <code>.metadata[:type_class]</code></h3>

<p>An approach I haven&rsquo;t tried yet, but I will soon, is to move the &ldquo;source of truth&rdquo; to the the class-based definition. The challenge here is that class-based definitions are not really used during validation and execution, so how can you reach configuration values on those classes?</p>

<p>The answer is that if a legacy-style type was derived from a class, that class is stored as <code>metadata[:type_class]</code>. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Project</span> <span class="o">&lt;</span> <span class="no">BaseObject</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">legacy_defn</span> <span class="o">=</span> <span class="no">Project</span><span class="o">.</span><span class="n">graphql_definition</span> <span class="c1"># Instance of GraphQL::ObjectType, just like `.define`</span>
</span><span class='line'><span class="n">legacy_defn</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:type_class</span><span class="o">]</span> <span class="c1"># `Project` class from above</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, you could update runtime code to read configurations from <code>type_defn.metadata[:type_class]</code>.</p>

<p>Importantly, <code>metadata[:type_class]</code> will be <code>nil</code> if the type <em>wasn&rsquo;t</em> derived from a class, so this approach is tough to use if some definitions are still using the <code>.define</code> API.</p>

<p>I haven&rsquo;t implemented this yet, but I will be doing it in the next few weeks so we can simplify our extensions and improve boot time.</p>

<h2>The End</h2>

<p>I&rsquo;m still wrapping up some loose ends in the codebase, but I thought I&rsquo;d share these notes in case they help you in your upgrade. If you run into trouble on anything mentioned here, please <a href="https://github.com/rmosolgo/graphql-ruby/issues/new">open an issue</a> on GraphQL-Ruby! I really want to support a smooth transition to this new API.</p>
</div>


  <footer>
    <p class="meta" style="color: #999999;">
      
  

<span class="byline author vcard">Posted by <span class="fn">Robert Mosolgo</span></span>

      








  


<time datetime="2018-04-09T09:52:00-04:00" pubdate data-updated="true">Apr 9<span>th</span>, 2018</time>
      

in
<span class="categories">
  
    <a class='category' href='/blog/categories/graphql/'>GraphQL</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <div class="other-posts">
      
        <div class="prev-post">
          <a href="/blog/2018/03/25/why-a-new-schema-definition-api/" title="Previous Post: Why a New Schema Definition API?">&laquo; Why a New Schema Definition API?</a>
        </div>
      
      
        <div class="next-post">
          <a href="/blog/2018/05/21/how-ripper-parses-variables/" title="Next Post: How Ripper parses variables">How Ripper parses variables &raquo;</a>
        </div>
      
    </p>
  </footer>
</article>
</div>


      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2018 Robert Mosolgo
</p>

</footer>
    











  </div>
</body>
</html>
